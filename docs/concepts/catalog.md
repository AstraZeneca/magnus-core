# Overview

Catalog provides a way to store and retrieve data generated by the individual steps of the dag either to downstream
steps of the dag. Catalog also provides a way to reproduce a historic magnus run on any other machine. Along with
the actual file, we also store the SHA id of the data catalog object in the logs to enable diagnostics. 

Magnus stores the data generated for every run in the catalog indexed by the unique run_id of the run. This enables
you to re-run an older run and debug in case of any errors with the actual datasets used. 

---
!!! Note

    Since the data is stored per-run, it might cause the catalog to inflate a lot. Please consider some clean up 
    mechanisms to regularly prune runs that are no longer relevant. 
---

As with all services of magnus, there are several providers of catalog and you can easily extend to create your own
cataloging system and use it in your runs. 

## Configuration

Configuring the catalog can be done as follows.

```yaml
catalog:
  type:
  config:
```

### type

The type of catalog you want. This should be one of the catalog types already available. 

By default FileSystem Catalog is given if no config is provided. 

### config

Any configuration variables accepted by the catalog provider. 

## Configuration within Step

Within a step of the dag, the catalog can be configured by

```yaml
catalog:
  ...

dag:
  steps:
    step name:
      ...
      catalog:
        get:
          - list
        put:
          - list
    
    ...
```

The actual cataloging is done in two stages:

- get: Get the data mentioned in the ```get``` from the catalog to ```compute_data_folder``` before executing the node.
- put: Store all the data mentioned in ```put``` from the ```compute_data_folder``` to catalog after executing the node. 

Both ```get``` and ```put``` can accept glob patterns. Internally we use 
[Pathlib match function](https://docs.python.org/3/library/pathlib.html#pathlib.PurePath.match) 
to match the name to pattern. 

---
!!! Note

    The ```put``` stage of the cataloging checks if the data source has been obtained from ```get``` phase and only puts a new
    record if there were changes observed during the execution of the node. 
---

## Interaction within code

You can also interact with the catalog within your python programs if it is convenient than providing it in yaml.

### Get from catalog

To get a file from the catalog, use ```get_from_catalog``` from magnus. 

For example, the below code gets the file ```interesting_data.csv``` from the catalog into ```data/``` folder.


```python
from magnus import get_from_catalog

def my_function():
  get_from_catalog('interesting.csv', destination_folder='data/')

```

### Put in catalog

To put a file into the catalog, use ```put_in_catalog``` from magnus. 

For example, the below code puts the file ```data/interesting_data.csv``` from the data folder into catalog.


```python
from magnus import put_in_catalog

def my_function():
  put_in_catalog('data/interesting.csv')

```

---
!!! Note

    Unlike ```put``` phase of the cataloging process, put_in_catalog does not check if the cataloging object has 
    changed and does a blind update.

---


## Parameterized definition

As with any part of the magnus configuration, you can parameterize the configuration of catalog to switch between 
catalog providers without changing the base definition. 

Please follow the example provided [here](../dag/#parameterized_definition) for more information. 


## Extensions

You can easily extend magnus to bring in your custom provider, if a default
implementation does not exist or you are not happy with the implementation. 
